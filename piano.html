<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å„¿ç«¥é’¢ç´ï¼ˆæ¨¡æ‹Ÿï¼‰</title>
  <style>
    :root { --radius: 18px; }
    body{
      margin:0; font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #f6f7fb; color:#111;
      display:flex; justify-content:center; padding: 24px;
    }
    .app{
      width:min(980px, 100%);
      background:#fff; border-radius: 24px; padding: 18px 18px 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom: 14px;
    }
    h1{ font-size: 18px; margin:0; }
    .hint{ font-size: 13px; color:#555; margin:0; }
    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      border:0; padding:10px 12px; border-radius: 14px; cursor:pointer;
      background:#111; color:#fff; font-weight:600;
    }
    .btn:active{ transform: translateY(1px); }
    .toggle{
      display:flex; align-items:center; gap:8px; font-size: 13px; color:#333;
      background:#f0f2f7; padding:10px 12px; border-radius: 14px;
      user-select:none;
    }
    input[type="range"]{ width: 140px; }

    .piano{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 12px;
      align-items: stretch;
      margin-top: 12px;
    }
    .key{
      border:0; border-radius: var(--radius);
      min-height: 140px;
      cursor:pointer;
      position:relative;
      color:#111;
      font-weight:800;
      font-size: 20px;
      display:flex; align-items:flex-end; justify-content:center;
      padding: 10px 8px;
      box-shadow: 0 10px 0 rgba(0,0,0,.12);
      transition: transform .05s ease, box-shadow .05s ease, filter .1s ease;
      touch-action: none;
      user-select:none;
    }
    .key small{
      position:absolute; top:10px; left:10px;
      font-size: 12px; font-weight:700; opacity:.8;
      background: rgba(255,255,255,.6);
      padding: 4px 8px; border-radius: 999px;
    }
    .key:active, .key.pressed{
      transform: translateY(6px);
      box-shadow: 0 4px 0 rgba(0,0,0,.12);
      filter: brightness(.98);
    }

    .panel{
      margin-top: 16px;
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background:#f8f9fd; border-radius: 18px; padding: 12px 14px;
    }
    .note{ font-weight: 800; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#fff; border: 1px solid #e3e6f2;
      padding: 2px 8px; border-radius: 10px;
      font-size: 12px;
    }

    @media (max-width: 720px){
      .piano{ grid-template-columns: repeat(4, 1fr); }
      .key{ min-height: 120px; font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>ğŸ¹ å„¿ç«¥é’¢ç´ï¼ˆæ¨¡æ‹Ÿï¼‰</h1>
        <p class="hint">ç‚¹å‡»/è§¦æ‘¸æŒ‰é”®å‘å£°ï¼›é”®ç›˜ï¼š<span class="kbd">A S D F J K L ;</span></p>
      </div>
      <div class="controls">
        <label class="toggle">
          éŸ³è‰²cat > /Users/leinan/Desktop/piano.html <<'EOF'
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å„¿ç«¥é’¢ç´ï¼ˆæ¨¡æ‹Ÿï¼‰</title>
  <style>
    :root { --radius: 18px; }
    body{
      margin:0; font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #f6f7fb; color:#111;
      display:flex; justify-content:center; padding: 24px;
    }
    .app{
      width:min(980px, 100%);
      background:#fff; border-radius: 24px; padding: 18px 18px 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom: 14px;
    }
    h1{ font-size: 18px; margin:0; }
    .hint{ font-size: 13px; color:#555; margin:0; }
    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      border:0; padding:10px 12px; border-radius: 14px; cursor:pointer;
      background:#111; color:#fff; font-weight:600;
    }
    .btn:active{ transform: translateY(1px); }
    .toggle{
      display:flex; align-items:center; gap:8px; font-size: 13px; color:#333;
      background:#f0f2f7; padding:10px 12px; border-radius: 14px;
      user-select:none;
    }
    input[type="range"]{ width: 140px; }

    .piano{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 12px;
      align-items: stretch;
      margin-top: 12px;
    }
    .key{
      border:0; border-radius: var(--radius);
      min-height: 140px;
      cursor:pointer;
      position:relative;
      color:#111;
      font-weight:800;
      font-size: 20px;
      display:flex; align-items:flex-end; justify-content:center;
      padding: 10px 8px;
      box-shadow: 0 10px 0 rgba(0,0,0,.12);
      transition: transform .05s ease, box-shadow .05s ease, filter .1s ease;
      touch-action: none;
      user-select:none;
    }
    .key small{
      position:absolute; top:10px; left:10px;
      font-size: 12px; font-weight:700; opacity:.8;
      background: rgba(255,255,255,.6);
      padding: 4px 8px; border-radius: 999px;
    }
    .key:active, .key.pressed{
      transform: translateY(6px);
      box-shadow: 0 4px 0 rgba(0,0,0,.12);
      filter: brightness(.98);
    }

    .panel{
      margin-top: 16px;
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background:#f8f9fd; border-radius: 18px; padding: 12px 14px;
    }
    .note{ font-weight: 800; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#fff; border: 1px solid #e3e6f2;
      padding: 2px 8px; border-radius: 10px;
      font-size: 12px;
    }

    @media (max-width: 720px){
      .piano{ grid-template-columns: repeat(4, 1fr); }
      .key{ min-height: 120px; font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>ğŸ¹ å„¿ç«¥é’¢ç´ï¼ˆæ¨¡æ‹Ÿï¼‰</h1>
        <p class="hint">ç‚¹å‡»/è§¦æ‘¸æŒ‰é”®å‘å£°ï¼›é”®ç›˜ï¼š<span class="kbd">A S D F J K L ;</span></p>
      </div>
      <div class="controls">
        <label class="toggle">
          éŸ³è‰²
          <select id="wave">
            <option value="sine">æŸ”å’Œï¼ˆsineï¼‰</option>
            <option value="triangle" selected>ç«¥è¶£ï¼ˆtriangleï¼‰</option>
            <option value="square">ç”µå­ï¼ˆsquareï¼‰</option>
            <option value="sawtooth">æ˜äº®ï¼ˆsawtoothï¼‰</option>
          </select>
        </label>
        <label class="toggle">
          éŸ³é‡
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.35" />
        </label>
        <button class="btn" id="stop">åœæ­¢æ‰€æœ‰å£°éŸ³</button>
      </div>
    </header>

    <div class="piano" id="piano"></div>

    <div class="panel">
      <div>å½“å‰éŸ³ç¬¦ï¼š<span class="note" id="now">â€”</span></div>
      <div>æç¤ºï¼šç§»åŠ¨ç«¯éœ€è¦å…ˆç‚¹ä¸€ä¸‹é¡µé¢æ‰èƒ½å¯åŠ¨éŸ³é¢‘ï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰ã€‚</div>
    </div>
  </div>

  <script>
    // 8ä¸ªé”®ï¼ˆCå¤§è°ƒä¸€ç»„ï¼‰ï¼Œé”®ç›˜æ˜ å°„ï¼šA S D F J K L ;
    const keys = [
      { name: "C",  freq: 261.63, kbd: "a", color: "#FF6B6B" },
      { name: "D",  freq: 293.66, kbd: "s", color: "#FFA94D" },
      { name: "E",  freq: 329.63, kbd: "d", color: "#FFD43B" },
      { name: "F",  freq: 349.23, kbd: "f", color: "#69DB7C" },
      { name: "G",  freq: 392.00, kbd: "j", color: "#4DABF7" },
      { name: "A",  freq: 440.00, kbd: "k", color: "#748FFC" },
      { name: "B",  freq: 493.88, kbd: "l", color: "#B197FC" },
      { name: "C2", freq: 523.25, kbd: ";", color: "#FF6BD6" },
    ];

    const pianoEl = document.getElementById("piano");
    const nowEl = document.getElementById("now");
    const waveEl = document.getElementById("wave");
    const volEl = document.getElementById("vol");
    const stopBtn = document.getElementById("stop");

    let audioCtx = null;
    const active = new Map(); // noteName -> {osc, gain, timeout}

    function ensureAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume();
      return audioCtx;
    }

    function stopNote(name) {
      const item = active.get(name);
      if (!item) return;

      clearTimeout(item.timeout);
      try {
        const ctx = ensureAudio();
        const t = ctx.currentTime;
        item.gain.gain.cancelScheduledValues(t);
        item.gain.gain.setValueAtTime(item.gain.gain.value || 0.0001, t);
        item.gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);
        item.osc.stop(t + 0.035);
      } catch (e) {}
      active.delete(name);
    }

    function playNote(note, holdMs = 650) {
      const ctx = ensureAudio();
      stopNote(note.name);

      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = waveEl.value;
      osc.frequency.value = note.freq;

      const t = ctx.currentTime;
      const volume = Math.max(0.0001, parseFloat(volEl.value));

      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(volume, t + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, t + holdMs / 1000);

      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(t);

      const timeout = setTimeout(() => stopNote(note.name), holdMs + 50);
      active.set(note.name, { osc, gain, timeout });

      nowEl.textContent = `${note.name} (${note.freq.toFixed(2)}Hz)`;
    }

    function stopAll() {
      for (const name of [...active.keys()]) stopNote(name);
      nowEl.textContent = "â€”";
    }

    // æ¸²æŸ“ç´é”®
    const btnEls = new Map();
    keys.forEach(note => {
      const btn = document.createElement("button");
      btn.className = "key";
      btn.style.background = note.color;
      btn.dataset.name = note.name;
      btn.innerHTML = `<small>${note.kbd.toUpperCase()}</small>${note.name}`;

      const down = (e) => {
        e.preventDefault();
        btn.classList.add("pressed");
        playNote(note, 700);
      };
      const up = (e) => {
        e.preventDefault();
        btn.classList.remove("pressed");
        // å¦‚æœä½ æƒ³â€œæ¾å¼€å³åœâ€ï¼Œå–æ¶ˆä¸‹ä¸€è¡Œæ³¨é‡Šï¼š
        // stopNote(note.name);
      };

      btn.addEventListener("pointerdown", down);
      btn.addEventListener("pointerup", up);
      btn.addEventListener("pointercancel", up);
      btn.addEventListener("pointerleave", up);

      pianoEl.appendChild(btn);
      btnEls.set(note.name, btn);
    });

    // é”®ç›˜æ”¯æŒ
    const kbdToNote = new Map(keys.map(n => [n.kbd, n]));
    const pressedSet = new Set();

    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if (!kbdToNote.has(k) || pressedSet.has(k)) return;
      pressedSet.add(k);
      const note = kbdToNote.get(k);
      btnEls.get(note.name)?.classList.add("pressed");
      playNote(note, 700);
    });

    window.addEventListener("keyup", (e) => {
      const k = e.key.toLowerCase();
      if (!kbdToNote.has(k)) return;
      pressedSet.delete(k);
      const note = kbdToNote.get(k);
      btnEls.get(note.name)?.classList.remove("pressed");
    });

    stopBtn.addEventListener("click", stopAll);

    // é¦–æ¬¡äº¤äº’åˆå§‹åŒ–éŸ³é¢‘
    window.addEventListener("pointerdown", ensureAudio, { once: true });
  </script>
</body>
</html>
